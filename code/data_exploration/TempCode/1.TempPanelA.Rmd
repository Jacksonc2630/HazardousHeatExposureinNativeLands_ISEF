```{r}
library(MetBrewer)
library(tidyverse)
library(cowplot)

## Calculate territory-level data
dat.territory <- dat.wbgt.summarised.merged.weighted.native.more.info %>%
  filter(!is.na(POP_2020), POP_2020 > 0)

## Calculate population-weighted values by territory and year
dat.territory.year <- dat.territory %>%
  group_by(native_id, NAME, STATE_NAME, year) %>%
  summarise(
    wbgt_28 = weighted.mean(wbgt_28, POP_2020, na.rm = TRUE),
    POPULATION = sum(POP_2020),
    .groups = "drop"
  ) %>%
  mutate(wbgt_28_pop = wbgt_28 * POPULATION)

## Take 5-year average for each territory
dat.territory.5year <- dat.territory.year %>%
  filter(year %in% years_wbgtmax[c((length(years_wbgtmax)-4):length(years_wbgtmax))]) %>%
  group_by(native_id, NAME, STATE_NAME) %>%
  summarise(
    wbgt_28_pop_mean = mean(wbgt_28_pop),
    .groups = "drop"
  )

## Count territories per state and create state labels
state_territory_counts <- dat.territory.5year %>%
  group_by(STATE_NAME) %>%
  summarise(
    n_territories = n_distinct(native_id),
    total_person_days = sum(wbgt_28_pop_mean),
    .groups = "drop"
  ) %>%
  mutate(STATE_LABEL = paste0(STATE_NAME, " (", n_territories, ")"))

## Calculate rank and merge
dat.rank <- state_territory_counts %>%
  arrange(total_person_days) %>%
  mutate(rank = row_number())

dat.plot <- dat.territory.5year %>%
  left_join(state_territory_counts, by = "STATE_NAME") %>%
  left_join(dat.rank %>% select(STATE_NAME, rank), by = "STATE_NAME")

## Build the plot with stacked bars showing individual territories
plot.stacked.bar.28 <- ggplot() + 
  geom_bar(data = dat.plot, 
           aes(x = reorder(STATE_LABEL, rank),
               y = wbgt_28_pop_mean),
           stat = "identity",
           fill = "#3A6482",
           color = "#407091",
           linewidth = 0.1,
           width = 0.85) +
  ylab(paste0('Mean annual number of dangerous hot-humid person-days\nfor Tribal Native Americans during ', (end_year_wbgt-4), '-', end_year_wbgt)) + 
  xlab('State (# of territories)') + 
  scale_y_continuous(
    label = scales::comma, 
    expand = expansion(mult = c(0.02, 0.05)),
    breaks = seq(0, max(dat.plot$total_person_days, na.rm = TRUE) + 10000000, by = 10000000)
  ) + 
  coord_flip() +
  theme_bw(base_size = 10) + 
  theme(
    panel.grid.major.x = element_line(color = "gray95", linewidth = 0.2),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),
    axis.text.x = element_text(angle = 0, size = 8, vjust = 0.5, margin = margin(t = 8)), 
    axis.text.y = element_text(size = 8, margin = margin(r = 8)),
    axis.title.x = element_text(margin = margin(t = 12)),
    axis.title.y = element_text(margin = margin(r = 12)),
    plot.title = element_text(hjust = 0.5),
    axis.line = element_line(colour = "black"), 
    panel.border = element_rect(colour = "black", linewidth = 0.5),
    strip.background = element_blank(),
    legend.position = 'none'
  )

## Save
pdf(paste0(wbgtmax.folder, "TempPanelA.pdf"), paper = "a4r", width = 0, height = 0)
print(plot.stacked.bar.28)
dev.off()

print(plot.stacked.bar.28)
```