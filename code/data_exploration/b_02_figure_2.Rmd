---
title: "Figure 2"
output: html_document
---

## First step to load packages and file locations etc.
```{r include=FALSE}
rm(list=ls())
project.folder = paste0(print(here::here()),'/')
source(paste0(project.folder,'create_folder_structure.R'))
source(paste0(functions.folder,'script_initiate.R'))

```

## Load specific plotting packages
```{r, message=FALSE}
# load required packages
library(data.table)
library(rgdal)
library(stringr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(cowplot)
library(MetBrewer)
library(scales)
library(readr)
library(broom)
library(forcats)
```

## Load WBGT regression and overtime file
```{r}
dat.wbgt.summarised.regression <- readRDS(
  paste0(wbgt.folder, 'weighted_area_raster_native_wbgtmax_daily_',
         start_year_wbgt, '_', end_year_wbgt, '_regression_analysis.rds')
) %>%
  mutate(native_id = str_pad(as.character(native_id), width = 7, side = "left", pad = "0"))

dat.wbgt.summarised <- readRDS(
  paste0(wbgt.folder, 'weighted_area_raster_native_wbgtmax_daily_',
         start_year_wbgt, '_', end_year_wbgt, '_over_time.rds')
) %>%
  mutate(
    native_id = as.character(native_id),
    native_id = str_pad(native_id, width = 7, side = "left", pad = "0"),
    year = as.numeric(as.character(year))
  )
```

## Prepare map structure
```{r}
# for map theme to plot in ggplot
theme_map = function(base_size=9, base_family=""){
    require(grid)
    theme_bw(base_size=base_size,base_family=base_family) %+replace%
    theme(axis.line=element_blank(),
    axis.text=element_blank(),
    axis.ticks=element_blank(),
    axis.title=element_blank(),
    panel.background=element_blank(),
    panel.border=element_blank(),
    panel.grid=element_blank(),
    panel.margin=unit(0,"lines"),
    plot.background=element_blank(),
    legend.position = 'bottom'
    )
}
```

## Load US shapefile for mapping
```{r}
shapefile.data <- readRDS(paste0(project.folder, "data/processed/shapefile_data_all.rds"))
us.main <- readRDS(paste0(project.folder, "data/processed/us_main_shapefile.rds"))
USA.df <- readRDS(paste0(project.folder, "data/processed/usa_map_data.rds"))

# Ensure character types
shapefile.data$GEOID <- as.character(shapefile.data$GEOID)
USA.df$native_id <- as.character(USA.df$native_id)
```

## Merge and calculate state-level weighted averages for Native lands
```{r}
dat.wbgt.summarised.merged.weighted.native.more.info <- dat.wbgt.summarised %>%
  left_join(
    shapefile.data %>% select(GEOID, NAME, STATE_NAME, FUNCSTAT, POP_2020),
    by = c('native_id' = 'GEOID')
  ) %>%
  filter(!is.na(STATE_NAME), !is.na(POP_2020), POP_2020 > 0)

dat.wbgt.summarised.merged.weighted.native <- dat.wbgt.summarised.merged.weighted.native.more.info %>%
  group_by(STATE_NAME, year) %>%
  summarise(
    wbgt_26 = weighted.mean(wbgt_26, POP_2020, na.rm = TRUE),
    wbgt_28 = weighted.mean(wbgt_28, POP_2020, na.rm = TRUE),
    wbgt_30 = weighted.mean(wbgt_30, POP_2020, na.rm = TRUE),
    wbgt_35 = weighted.mean(wbgt_35, POP_2020, na.rm = TRUE),
    .groups = "drop"
)

STATES <- unique(dat.wbgt.summarised.merged.weighted.native$STATE_NAME)


dat.wbgt.summarised.merged.weighted.native.national <- dat.wbgt.summarised.merged.weighted.native.more.info %>%
  group_by(year) %>%
  summarise(
    wbgt_26 = weighted.mean(wbgt_26, POP_2020, na.rm = TRUE),
    wbgt_28 = weighted.mean(wbgt_28, POP_2020, na.rm = TRUE),
    wbgt_30 = weighted.mean(wbgt_30, POP_2020, na.rm = TRUE),
    wbgt_35 = weighted.mean(wbgt_35, POP_2020, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(STATE_NAME = 'USA') %>%
  relocate(STATE_NAME)

dat.wbgt.summarised.merged.weighted.native <- bind_rows(
  dat.wbgt.summarised.merged.weighted.native,
  dat.wbgt.summarised.merged.weighted.native.national
) %>%
  mutate(STATE_NAME = factor(STATE_NAME, levels = rev(c('USA', STATES))))

```

## Load state file over time
```{r}
dat.wbgt.summarised.merged.weighted.state <- readRDS(
  paste0(wbgt.folder, 'weighted_area_raster_state_wbgtmax_daily_',
         start_year_wbgt, '_', end_year_wbgt, '_over_time.rds')
) %>%
  rename(
    wbgt_26_state = wbgt_26,
    wbgt_28_state = wbgt_28,
    wbgt_30_state = wbgt_30,
    wbgt_35_state = wbgt_35
  )
```

## Merge Native average vs. state to compare
```{r}
states_data <- readOGR(
  dsn = paste0(data.folder, "shapefiles/states"),
  layer = "states",
  verbose = FALSE
)@data

state_lookup <- shapefile.data %>%
  distinct(STATE_NAME) %>%
  left_join(
    states_data %>% select(STATE_NAME, STATE_FIPS),
    by = "STATE_NAME"
  )

dat.wbgt.summarised.merged.weighted.native.state <- dat.wbgt.summarised.merged.weighted.native %>%
  left_join(state_lookup, by = "STATE_NAME") %>%
  rename(
    wbgt_26_native = wbgt_26,
    wbgt_28_native = wbgt_28,
    wbgt_30_native = wbgt_30,
    wbgt_35_native = wbgt_35,
    state = STATE_FIPS
  ) %>%
  left_join(dat.wbgt.summarised.merged.weighted.state, by = c('state', 'year')) %>%
  mutate(
    wbgt_26_diff = wbgt_26_native - wbgt_26_state,
    wbgt_28_diff = wbgt_28_native - wbgt_28_state,
    wbgt_30_diff = wbgt_30_native - wbgt_30_state,
    wbgt_35_diff = wbgt_35_native - wbgt_35_state
  )

```


## Merge individual Native vs. state to compare
```{r}
dat.wbgt.summarised.merged.individual.native.state <- dat.wbgt.summarised.merged.weighted.native.more.info %>%
  select(native_id, year, wbgt_26, wbgt_28, wbgt_30, wbgt_35, STATE_NAME) %>%
  rename(
    wbgt_26_native = wbgt_26,
    wbgt_28_native = wbgt_28,
    wbgt_30_native = wbgt_30,
    wbgt_35_native = wbgt_35
  ) %>%
  left_join(state_lookup, by = "STATE_NAME") %>%
  rename(state = STATE_FIPS) %>%
  left_join(dat.wbgt.summarised.merged.weighted.state, by = c('state', 'year')) %>%
  mutate(
    wbgt_26_diff = wbgt_26_native - wbgt_26_state,
    wbgt_28_diff = wbgt_28_native - wbgt_28_state,
    wbgt_30_diff = wbgt_30_native - wbgt_30_state,
    wbgt_35_diff = wbgt_35_native - wbgt_35_state
  )
```

## Trends in growth of individual Native disparity per year over time
```{r}
years_wbgtmax <- sort(unique(dat.wbgt.summarised.merged.individual.native.state$year))

# WBGT 26°C
dat.wbgt.summarised.regression.26 <- dat.wbgt.summarised.merged.individual.native.state %>%
  group_by(native_id) %>%
  do(tidy(lm(wbgt_26_diff ~ year, data = .))) %>%
  filter(term == 'year') %>%
  select(native_id, estimate) %>%
  mutate(
    total_change_disparity_wbgt_26 = estimate * length(years_wbgtmax),
    annual_change_disparity_wbgt_26 = estimate
  ) %>%
  select(native_id, annual_change_disparity_wbgt_26, total_change_disparity_wbgt_26)

# WBGT 28°C
dat.wbgt.summarised.regression.28 <- dat.wbgt.summarised.merged.individual.native.state %>%
  group_by(native_id) %>%
  do(tidy(lm(wbgt_28_diff ~ year, data = .))) %>%
  filter(term == 'year') %>%
  select(native_id, estimate) %>%
  mutate(
    total_change_disparity_wbgt_28 = estimate * length(years_wbgtmax),
    annual_change_disparity_wbgt_28 = estimate
  ) %>%
  select(native_id, annual_change_disparity_wbgt_28, total_change_disparity_wbgt_28)

# WBGT 30°C
dat.wbgt.summarised.regression.30 <- dat.wbgt.summarised.merged.individual.native.state %>%
  group_by(native_id) %>%
  do(tidy(lm(wbgt_30_diff ~ year, data = .))) %>%
  filter(term == 'year') %>%
  select(native_id, estimate) %>%
  mutate(
    total_change_disparity_wbgt_30 = estimate * length(years_wbgtmax),
    annual_change_disparity_wbgt_30 = estimate
  ) %>%
  select(native_id, annual_change_disparity_wbgt_30, total_change_disparity_wbgt_30)

# WBGT 35°C
dat.wbgt.summarised.regression.35 <- dat.wbgt.summarised.merged.individual.native.state %>%
  group_by(native_id) %>%
  do(tidy(lm(wbgt_35_diff ~ year, data = .))) %>%
  filter(term == 'year') %>%
  select(native_id, estimate) %>%
  mutate(
    total_change_disparity_wbgt_35 = estimate * length(years_wbgtmax),
    annual_change_disparity_wbgt_35 = estimate
  ) %>%
  select(native_id, annual_change_disparity_wbgt_35, total_change_disparity_wbgt_35)
```

## Merge regression analyses into one data frame
```{r}
dat.wbgt.summarised.regression.merged <- dat.wbgt.summarised.regression.26 %>%
  left_join(dat.wbgt.summarised.regression.28, by = "native_id") %>%
  left_join(dat.wbgt.summarised.regression.30, by = "native_id") %>%
  left_join(dat.wbgt.summarised.regression.35, by = "native_id")
```

## Load US state shapefile for mapping
```{r}
us <- readOGR(dsn = paste0(data.folder, "shapefiles/states"), layer = "states", verbose = FALSE)

us_aea <- spTransform(
  us,
  CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs")
)
us_aea@data$id <- rownames(us_aea@data)
us_aea <- us_aea[us_aea$STATE_FIPS %in% states_included, ]
us_aea <- spTransform(
  us_aea,
  CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs")
)
us_aea <- fortify(us_aea)
```

## Add disparity regression to other regression data
```{r}
dat.wbgt.summarised.regression <- dat.wbgt.summarised.regression %>%
  left_join(dat.wbgt.summarised.regression.merged, by = "native_id")
```

## Prepare summary maps
```{r}
# First ensure shapefile.data has character GEOID
shapefile.data <- shapefile.data %>%
  mutate(GEOID = as.character(GEOID))

# Merge map data with shapefile info FIRST, then with regression data
USA.df.merged <- USA.df %>%
  mutate(native_id = as.character(native_id)) %>%
  # Join shapefile data first to get population info
  left_join(
    shapefile.data %>% select(GEOID, NAME, STATE_NAME, FUNCSTAT, POP_2020),
    by = c("native_id" = "GEOID")
  ) %>%
  # Filter for territories with population BEFORE joining regression data
  filter(!is.na(POP_2020), POP_2020 > 0) %>%
  # Now join regression data
  left_join(dat.wbgt.summarised.regression, by = 'native_id') %>%
  arrange(id, order)
```

## Define sub-header numbers
```{r}
legend_create_total_change <- function(threshold) {
  paste0('Total change in annual number of\ndangerous hot-humid days during ',
         start_year_wbgt, '-', end_year_wbgt)
}

legend_create_total_disparity_change <- function(threshold) {
  paste0('Total change in disparity of annual number of\ndangerous hot-humid days during ',
         start_year_wbgt, '-', end_year_wbgt)
}
```

## Define legend functions
```{r}
legend_create_total_change <- function(threshold) {
  paste0('Total change in annual number of\ndangerous hot-humid days during ',
         start_year_wbgt, '-', end_year_wbgt)
}

legend_create_total_disparity_change <- function(threshold) {
  paste0('Total change in disparity of annual number of\ndangerous hot-humid days during ',
         start_year_wbgt, '-', end_year_wbgt)
}
```

## Plot heatmap of state-year differences (Panel a)
```{r}
plot_state_year_difference_sorted <- function(threshold_chosen, legend_chosen = 0) {
  
  dat.plot <- dat.wbgt.summarised.merged.weighted.native.state %>%
    filter(STATE_NAME != 'USA') %>%
    group_by(STATE_NAME) %>%
    mutate(mean_diff = mean(get(paste0('wbgt_', threshold_chosen, '_diff')), na.rm = TRUE)) %>%
    arrange(mean_diff) %>%
    ungroup() %>%
    mutate(STATE.sorted = fct_inorder(STATE_NAME, ordered = TRUE))
  
p <- ggplot() +
  geom_tile(
    data = dat.plot,
    aes(x = year, y = STATE.sorted, fill = get(paste0('wbgt_', threshold_chosen, '_diff'))),
    size = 1,
    height = 1
  ) +
  xlab("Year") +
  ylab("State") +
  ylim(levels(dat.plot$STATE.sorted)) +
  scale_fill_gradient2(
    low = met.brewer("Demuth")[10],
    mid = "white",
    high = met.brewer("Demuth")[1],
    na.value = "white"
  ) +
  coord_fixed(ratio = 1) +    #Change Ratio for stretching of panel A
  theme_bw() +
  theme(
    text = element_text(size = 10),
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    panel.border = element_rect(colour = "black"),
    legend.position = "bottom",
    legend.justification = "center",
    legend.background = element_rect(fill = "white", size = .5, linetype = "dotted")
  )
  
  if (legend_chosen == 0) {
    p <- p + guides(fill = "none")
  }
  if (legend_chosen == 1) {
    p <- p +
      guides(
        fill = guide_colorbar(
          direction = "horizontal",
          title.position = "left",
          barwidth = 10,
          barheight = 1,
          title.vjust = 0.8,
          title = "Population-weighted difference in annual number of\nhot-humid days between Native lands and rest of state"
        )
      ) +
      theme(legend.text = element_text(size = 5))
  }
  
  return(p)
}
plot.state.year.diff.28.sorted <- plot_state_year_difference_sorted(28, 1)
```

## Plot total change map (Panel b)
```{r}
plot_total_change <- function(threshold_chosen, legend_chosen = 0) {
  
  wbgt_col <- paste0('total_change_wbgt_', threshold_chosen)
  max_abs <- max(abs(USA.df.merged[[wbgt_col]]), na.rm = TRUE)
  
  p <- ggplot() +
    geom_polygon(
      data = us_aea,
      aes(x = long, y = lat, group = group),
      fill = 'grey35',
      color = 'black',
      size = 0.5
    ) +
    geom_polygon(
      data = USA.df.merged,
      aes(x = long, y = lat, group = group, fill = .data[[wbgt_col]]),
    ) +
    scale_fill_gradientn(
      colors = rev(met.brewer('Cassatt2')),
      limits = c(-max_abs, max_abs),
      na.value = "grey35"
    ) +
    coord_fixed() +
    xlab('') +
    ylab('') +
    theme_bw() +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 90),
      axis.ticks.x = element_blank(),
      legend.text = element_text(size = 5),
      axis.line = element_line(colour = "black"),
      panel.border = element_rect(colour = "black"),
      strip.background = element_blank(),
      legend.justification = 'center',
      legend.position = 'bottom',
      legend.background = element_rect(fill = "white", size = .5, linetype = "dotted")
    ) +
    theme_map()
  
  if (legend_chosen == 0) {
    p <- p + guides(fill = "none")
  }
  if (legend_chosen == 1) {
    p <- p +
      guides(
        fill = guide_colorbar(
          direction = "horizontal",
          title.position = "left",
          barwidth = 10,
          barheight = 1,
          title.vjust = 0.8,
          title = legend_create_total_change(threshold_chosen)
        )
      ) +
      theme(legend.text = element_text(size = 5))
  }
  
  return(p)
}

plot.total.change.28 <- plot_total_change(28, 1)
```

## Plot total disparity change map (Panel c)
```{r}
plot_total_disparity_change <- function(threshold_chosen, legend_chosen = 0) {
  
  wbgt_col <- paste0('total_change_disparity_wbgt_', threshold_chosen)
  max_abs <- max(abs(USA.df.merged[[wbgt_col]]), na.rm = TRUE)
  
  p <- ggplot() +
    geom_polygon(
      data = us_aea,
      aes(x = long, y = lat, group = group),
      fill = 'grey35',
      color = 'black',
      size = 0.5
    ) +
    geom_polygon(
      data = USA.df.merged,
      aes(x = long, y = lat, group = group, fill = .data[[wbgt_col]]),
    ) +
    scale_fill_gradientn(
      colors = rev(met.brewer('Isfahan1')),
      limits = c(-max_abs, max_abs),
      na.value = "grey35"
    ) +
    coord_fixed() +
    xlab('') +
    ylab('') +
    theme_bw() +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 90),
      axis.ticks.x = element_blank(),
      legend.text = element_text(size = 5),
      axis.line = element_line(colour = "black"),
      panel.border = element_rect(colour = "black"),
      strip.background = element_blank(),
      legend.justification = 'center',
      legend.position = 'bottom',
      legend.background = element_rect(fill = "white", size = .5, linetype = "dotted")
    ) +
    theme_map()
  
  if (legend_chosen == 0) {
    p <- p + guides(fill = "none")
  }
  if (legend_chosen == 1) {
    p <- p +
      guides(
        fill = guide_colorbar(
          direction = "horizontal",
          title.position = "left",
          barwidth = 10,
          barheight = 1,
          title.vjust = 0.8,
          title = legend_create_total_disparity_change(threshold_chosen)
        )
      ) +
      theme(legend.text = element_text(size = 5))
  }
  
  return(p)
}

plot.total.disparity.change.28 <- plot_total_disparity_change(28, 1)
```

## Create final figure (28°C)
```{r fig.width=14, fig.height=10}
# Nest maps (b) and (c)
nested.28 <- plot_grid(
  plot.total.change.28,
  plot.total.disparity.change.28,
  nrow = 2,
  label_size = 14,
  label_x = 0,
  label_y = 0.99,
  labels = c('(b)', '(c)')
)

# Combine heatmap (a) with nested maps
plot.28.sorted <- plot_grid(
  plot.state.year.diff.28.sorted,
  nested.28,
  ncol = 2,
  label_size = 14,
  label_x = 0,
  label_y = 0.99,
  labels = c('(a)', ''),
  rel_widths = c(1, 1)
)

print(plot.28.sorted)
```

## Save figure
```{r}
pdf(
  paste0(figures.folder, 'Figure_2.pdf'),
    width = 16,
    height = 9,
    pointsize = 12)
print(plot.28.sorted)
dev.off()
```

## Save output data for Figure 2a
```{r}
dat.wbgt.summarised.merged.weighted.native.state.output <- dat.wbgt.summarised.merged.weighted.native.state %>%
  filter(STATE_NAME != 'USA') %>%
  select(state, STATE_NAME, year, wbgt_28_diff) %>%
  mutate(wbgt_28_diff = round(wbgt_28_diff, 1))

write_csv(
  dat.wbgt.summarised.merged.weighted.native.state.output,
  paste0(figures.folder, 'Figure_2a_native.csv')
)
```

## Save output data for Figure 2b
```{r}
dat.wbgt.summarised.regression.output <- dat.wbgt.summarised.regression %>%
  select(native_id, total_change_wbgt_28) %>%
  mutate(total_change_wbgt_28 = round(total_change_wbgt_28, 1)) %>%
  left_join(shapefile.data, by = c('native_id' = 'GEOID')) %>%
  filter(!is.na(POP_2020), POP_2020 > 0) %>%
  select(native_id, total_change_wbgt_28, NAME, STATE_NAME, POP_2020)

write_csv(
  dat.wbgt.summarised.regression.output,
  paste0(figures.folder, 'Figure_2b_native.csv')
)
```

## Save output data for Figure 2c
```{r}
dat.wbgt.summarised.regression.disparity.output <- dat.wbgt.summarised.regression %>%
  select(native_id, total_change_disparity_wbgt_28) %>%
  mutate(total_change_disparity_wbgt_28 = round(total_change_disparity_wbgt_28, 1)) %>%
  left_join(shapefile.data, by = c('native_id' = 'GEOID')) %>%
  filter(!is.na(POP_2020), POP_2020 > 0) %>%
  select(native_id, total_change_disparity_wbgt_28, NAME, STATE_NAME, POP_2020)

write_csv(
  dat.wbgt.summarised.regression.disparity.output,
  paste0(figures.folder, 'Figure_2c_native.csv')
)
```