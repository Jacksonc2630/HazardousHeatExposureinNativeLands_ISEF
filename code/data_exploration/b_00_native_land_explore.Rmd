---
title: "Native land explore"
output: html_document
---

## Load file locations
```{r include=FALSE}
rm(list=ls())
project.folder = paste0(print(here::here()),'/')
source(paste0(project.folder,'create_folder_structure.R'))
source(paste0(functions.folder,'script_initiate.R'))
```

## Load specific plotting packages
```{r, message=FALSE}
# load required packages
library(ggplot2)
library(rgdal)
library(sf)
library(dplyr)
library(tidyr)
library(readr)
library(purrr)
library(stringr)
```

## Prepare map structure
```{r}
# for map theme to plot in ggplot
theme_map = function(base_size=8, base_family=""){
    require(grid)
    theme_bw(base_size=base_size,base_family=base_family) %+replace%
    theme(axis.line=element_blank(),
    axis.text=element_blank(),
    axis.ticks=element_blank(),
    axis.title=element_blank(),
    panel.background=element_blank(),
    panel.border=element_blank(),
    panel.grid=element_blank(),
    panel.spacing=unit(0,"lines"),
    plot.background=element_blank(),
    legend.position = 'bottom'
    )
}
```

## Load Shapefile Data
```{r}
load_native_boundaries = function(project.folder) {
  us.main = readOGR(
    dsn = paste0(project.folder, "data/shapefiles/native_boundaries/"),
    layer = "tl_2020_us_aitsn",
    verbose = FALSE
  ) %>%
    spTransform(CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"))
 
  us.main@data$GEOID = str_pad(as.character(us.main@data$GEOID), width = 7, side = "left", pad = "0")
  us.main@data$id = rownames(us.main@data)
  message("Loaded ", nrow(us.main@data), " native territories")
  return(us.main)
}

```

## Load Population Data
```{r}
load_population_data = function(project.folder) {
  pop.files = list.files(
    paste0(project.folder, "data/population/2000-2020/"),
    pattern = "\\.csv$",
    full.names = TRUE
  )

  pop.data.wide <- map_df(pop.files, ~{
    read_csv(.x, show_col_types = FALSE,
             col_types = cols(GEOID   = col_character(),
                              population = col_double())) %>%
      mutate(year  = as.integer(str_extract(basename(.x), "\\d{4}")),
             GEOID = str_pad(GEOID, width = 7, side = "left", pad = "0"))
  }) %>%
    pivot_wider(names_from  = year,
                values_from = population,
                names_prefix = "POP_")

  message("Population data: ", nrow(pop.data.wide), " territories | ",
          "2020 total: ", format(sum(pop.data.wide$POP_2020, na.rm = TRUE), big.mark = ","))
  pop.data.wide
}
```

## State Assignment
```{r}
assign_state_info = function(native_sp, shapefile.data, project.folder) {
  states_sf = st_read(
    paste0(project.folder, "data/shapefiles/states/states.shp"),
    quiet = TRUE
  )
  
  native_sf_with_state = st_as_sf(native_sp) %>%
    st_transform(st_crs(states_sf)) %>%
    st_join(states_sf, join = st_intersects) %>%
    group_by(GEOID) %>%
    mutate(
      overlap_count = n(),
      weight = 1 / overlap_count
    ) %>%
    ungroup() %>%
    left_join(
      shapefile.data %>% select(GEOID, starts_with("POP_")),
      by = "GEOID"
    ) %>%
    mutate(weighted_pop = POP_2020 * weight)
  
  state_lookup = native_sf_with_state %>%
    st_drop_geometry() %>%
    group_by(GEOID) %>%
    slice(1) %>%
    ungroup() %>%
    select(GEOID, STATE_NAME)
  
  message("After spatial join: ", nrow(native_sf_with_state), " rows | ",
          nrow(state_lookup), " unique territories | ",
          n_distinct(state_lookup$STATE_NAME, na.rm = TRUE), " states")
  
  return(list(
    state_lookup = state_lookup,
    native_sf_with_state = native_sf_with_state
  ))
}
```

## Main Processing
```{r}
# Load data
us.main = load_native_boundaries(project.folder)
pop.data.wide = load_population_data(project.folder)

# Merge population with shapefile
shapefile.data = us.main@data %>%
  as_tibble() %>%
  left_join(pop.data.wide, by = "GEOID") %>%
  mutate(across(starts_with("POP_"), as.numeric))

message("Merged: ", nrow(shapefile.data), " rows | ",
        sum(!is.na(shapefile.data$POP_2020)), " with 2020 pop")

# Add state information
state_results = assign_state_info(us.main, shapefile.data, project.folder)
native_sf_with_state = state_results$native_sf_with_state
state_lookup = state_results$state_lookup

shapefile.data = shapefile.data %>%
  left_join(state_lookup, by = "GEOID")

message("Final: ", sum(!is.na(shapefile.data$STATE_NAME)), " territories with states")
```

## Prepare Map Data
```{r, warning=FALSE}
map = fortify(us.main)
USA.df = merge(map, us.main@data, by = "id") %>%
  mutate(native_id = str_pad(as.character(GEOID), width = 7, side = "left", pad = "0"))
message("\nMap data prepared: ", nrow(USA.df), " polygon vertices")

## Save files
saveRDS(shapefile.data, paste0(project.folder, "data/processed/shapefile_data_all.rds"))
saveRDS(us.main, paste0(project.folder, "data/processed/us_main_shapefile.rds"))
saveRDS(USA.df, paste0(project.folder, "data/processed/usa_map_data.rds"))

message("\nSaved corrected files!")
```

## Calculate Statistics
```{r}
# State-level populations
state_pop = native_sf_with_state %>%
  st_drop_geometry() %>%
  group_by(STATE_NAME) %>%
  summarise(
    total_pop = sum(weighted_pop, na.rm = TRUE),
    n_territories = n_distinct(GEOID),
    .groups = "drop"
  ) %>%
  arrange(desc(total_pop))

# Summary statistics
territories_with_pop = sum(!is.na(shapefile.data$POP_2020) & shapefile.data$POP_2020 > 0)
territories_no_pop = sum(is.na(shapefile.data$POP_2020) | shapefile.data$POP_2020 == 0)

message("SUMMARY STATISTICS")
message("Total territories: ", nrow(shapefile.data))
message("Unique names: ", n_distinct(shapefile.data$NAME))
message("States with territories: ", n_distinct(state_lookup$STATE_NAME, na.rm = TRUE))
message("Total 2020 population: ", format(sum(shapefile.data$POP_2020, na.rm = TRUE), big.mark = ","))
message("Territories with pop > 0: ", territories_with_pop)
message("Territories with NA/zero pop: ", territories_no_pop)

# FUNCSTAT distribution
funcstat_counts = shapefile.data %>%
  group_by(FUNCSTAT) %>%
  summarise(
    n = n(),
    pop = sum(POP_2020, na.rm = TRUE),
    .groups = "drop"
  )

# Territory counts
name_counts = shapefile.data %>%
  count(NAME, sort = TRUE)

state_counts = shapefile.data %>%
  filter(!is.na(STATE_NAME)) %>%
  count(STATE_NAME, sort = TRUE)
```

## Extra Data Table Stats
```{r}
# Population by State
print(state_pop, n = Inf)
# Population by Native land (A (Active/Federal),N (non-reservation/trust land),S(State))
print(funcstat_counts)
# Territories by State
print(state_counts, n = Inf)
```


